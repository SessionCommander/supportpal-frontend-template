{% extends parent_template %}

{% block meta %}
    <meta name="robots" content="noindex" />
    <meta name="ticket-subject" content="{{ ticket.subject }}" />
    {% if download %}
        <meta http-equiv="refresh" content="2;{{ download.direct_frontend_url }}" />
    {% endif %}

    <style>
        @media print {
            body * { display: none; }
            .sp-use-print-view { display: block !important; }
        }
    </style>
{% endblock %}

{% block title %}{{ ticket.subject }}{% endblock %}

{% block breadcrumb %}
    <span class="page-header-breadcrumb-separator">&raquo;</span>
    <a href="{{ route('ticket.frontend.ticket.index') }}">{{ Lang.choice('ticket.ticket', 2) }}</a>
    <span class="page-header-breadcrumb-separator">&raquo;</span>
    <span>{{ Lang.choice('ticket.ticket', 1) }} #{{ ticket.number }}</span>
{% endblock %}

{% block page_title %}
    {{ ticket.subject }}
{% endblock %}

{% block sidebar %}
    <div class="sp-sidebar" style="flex: none; width: 100%; padding: 0; margin-bottom: 1.5rem;">
        {{ View.fireHook('frontend.sidebar_start') }}

        <div class="sp-sidebar-box">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: white; margin-bottom: 1rem; font-family: var(--font-playfair);">{{ Lang.get('ticket.ticket_details') }}</h2>

            <div>
                {% include 'frontend.' ~ template ~ '.ticket.ticket_details' %}

                {% if customfields is not empty %}
                    {% include 'frontend.' ~ template ~ '.ticket.ticket_custom_fields' %}
                {% endif %}
            </div>
        </div>

        {{ View.fireHook('frontend.sidebar_end') }}
    </div>
{% endblock %}

{% block precontent %}
    <div class="sp-use-print-view sp-hidden">
        {{ Lang.get('ticket.use_ticket_print_view') }}
    </div>

    <div class="sp-ticket-update sp-alert sp-alert-success sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto">
            {{ Lang.get('messages.success_updated', {'item': mb_strtolower(Lang.choice('ticket.ticket', 1), 'UTF-8')}) }}
        </div>
    </div>
    <div class="sp-ticket-update sp-alert sp-alert-error sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto">
            {{ Lang.get('messages.error_updated', {'item': mb_strtolower(Lang.choice('ticket.ticket', 1), 'UTF-8')}) }}
        </div>
    </div>

    <div class="sp-ticket-reply sp-alert sp-alert-success sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto">
            {{ Lang.get('messages.success_updated', {'item': mb_strtolower(Lang.choice('ticket.ticket', 1), 'UTF-8')}) }}
        </div>
    </div>
    <div class="sp-ticket-reply sp-alert sp-alert-error sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto">
            {{ Lang.get('messages.error_updated', {'item': mb_strtolower(Lang.choice('ticket.ticket', 1), 'UTF-8')}) }}
        </div>
    </div>

    <div class="sp-ticket-custom sp-alert sp-alert-error sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto"></div>
    </div>

    <div class="attachment sp-alert sp-alert-error sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto"></div>
    </div>
    <div class="sp-all-attachments sp-alert sp-alert-info sp-alert-sticky sp-hidden">
        <div class="sp-container sp-mx-auto">{{ Lang.get('ticket.downloading') }}</div>
    </div>
{% endblock %}

{% block content %}

    {% if download %}
        <div class="sp-alert">
            <i class="fas fa-times sp-alert-close" title="{{ Lang.get('general.close') }}"></i>
            <strong>{{ Lang.get('ticket.downloading') }}</strong><br />
            {{ Lang.get('ticket.downloading_desc', {'href': download.direct_frontend_url|e})|raw }}
        </div>
    {% endif %}

    {% if ticket.locked == 1 %}
        <div class="sp-ticket-locked sp-alert sp-alert-error">
            {{ Lang.get('ticket.error_ticket_locked') }}
        </div>
    {% endif %}

    {% if feedbackToken is not null %}
        <div class="sp-feedback sp-alert sp-text-center">
            <p class="sp-mt-0 sp-mb-3">{{ Lang.get('ticket.feedback_desc') }}</p>

            <div class="sp-flex sp-flex-wrap">
                <div class="sp-w-full sm:sp-w-1/3">
                    <a href="{{ route('ticket.frontend.ticket.feedback', [ ticket.number, feedbackToken ]) }}?rating=1">
                        <img class="sp-inline" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAABqlBMVEUAAAAuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEuzHEeM3AYAAAAjXRSTlMAAQIDBAUGBwgJCgsMDg8QERITFBUWFxgaGxwdHh8gIiQmKSorLC4vMDIzNDY4OTo8Pj9BQ0RFR0lKS0xOT1RVVldYWVtcXV5hYmNmaG9zdHV4fH5/hYiLjo+UlZeYmp6gpaaoqqutr7C1t7q8vsHDxcfIzM7P0dPV19na3ODi5Obo6evt7/Hz9ff5+/3xUOGfAAACRklEQVQYGYXBiSOTYQDH8d+z7Z0iYpPpkhrpPuhS6dKlRBedohKx7kQpraKY7fs/9zzvsA2tz0cFvH3dbzJYk73Hy/VPdQPke3/YaDWxUZabOqgVTCfOrzv7akrDayvj18dwnq5RIe8V1qt65VT1Ys3ElK/0CzDZpEKRZ0A6rpzQZ+BxQCucBtK1WmRGgA6tpn4WZkq1oB3o1OrqgGFlVWagX5ZpaIlokWloicg6ARyVrx9+BiWFx4CLygqPAVdkPYTpgKwo0CyrByciXw9OtaR1wClZt2HCyEritMiXxDkm6yZMSTKzsF9OAqdBvgROk6y1QEzaCpmgnEasMSNfI9a4kTME16Q2eK6sxkSyJ6wFjYlkT1i+VngpPYBzKq4G5qW3sFPFeYCnKdik4gxQpnmo1n8AVfoBG1WcAdbpA8RVXAgI6wm0ybf+zUBQeZon2+WLQMboAvTJdxfOKMfLQEhOM7yWtsOckdMGyYCWXIXv8vXBDSmQhrickjT0atGmDJyR4wF1kh5AQr7LwP2gfLtTMBWQ0w4zRtJWoEGOGQamr26piB4YAdIxOV4KOuSMwoSRExwkZ3abfF2Q8uRsBm7JZ86mWfCiTL4dwCVl3QKOKMs7OZiC8a6Ysirm4KNRVmAC2K8lRksqvkI6qkVl00CnVorPAbuUs+E3MBxVIa8bq1X5yr9h3StXTuh8CsjsUSGvDyfRVhs2Uqjq0KMM1qdqrbD3O8vNdxitwrRMku9PZ1j/Er08lML3rrveqDivrKq8xGi5v+9pCmPJArjSAAAAAElFTkSuQmCC" alt="{{ Lang.get('ticket.good_satisfied') }}">
                        <div class="sp-mt-1 sp-font-semibold">{{ Lang.get('ticket.good_satisfied') }}</div>
                    </a>
                </div>
                <div class="sp-w-full sp-mt-3 sm:sp-w-1/3 sm:sp-mt-0">
                    <a href="{{ route('ticket.frontend.ticket.feedback', [ ticket.number, feedbackToken ]) }}?rating=2">
                        <img class="sp-inline" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAABmFBMVEUAAADxxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/xxA/4+wrwAAAAh3RSTlMAAQIDBAUGBwgJCgsMDQ4PERITFBUWFxgaGxwdHyAkJikqKywuLzAzNDY4Ojw+P0FDREVHSUpMTk9SVFZXWFlcXV5iY2Zob3BzdHV4fH6ChYaIiYuPlJWXmJqeoKWmqK2vsLK1t7q8vsHDxcfIzM7P0dPV19na3ODi5Obo6evt7/Hz9ff5+/36/rmZAAACCUlEQVQYGYXBCUNMUQCG4e9M3aFFNU2apIYpoVBZIkWIKNkiVKJQ2SMiad/m/dvOuVNqVs+jJF5j3/s41uzA+RJlVfuCvT6dMcokMkGquVNKY3pwFu83VhYGC8pit6ZxRvcrmTeFNRXVrtAA1nJEexX+AGYblKz8JbAV067878DzgNJcAraqtMO8BbqVSXQNlgu1rQvoUWa1wLgSyuIwIsvUtYT1T7S1WtYF4Kx8I7CQJyk4DdxQgnkDPJb1FJYCssJAs6yHOBXydeI0SCoGLsq6BzNG1jzOOflGce7IugtzkswaNMmZxGmQ7wHOZVkFQESqgXienHqsb0a+MNZKUM4Y3JTa4ZUS6ifnHwW1rWpsYfiAfG3wWhqETuVWCZvSBzim3DzA0xxUKzcDFGkTKvQfQEh/4JByM0CxPkNMueUDQQ1DuxICXgojXznEja7CkHwdpFqNyGmGd9IRWDdyFknTK2cIbkuBLYjJ6SDVWkSWB9RKGoRJ+QJeCiOnC5aNpBqgTtl5G9AtZwJmjLLqhQ1PzmGgX9kcBa4poR9oVWal6/DFKCEwAzQpk9KfsBXWjqIloEfpYuvAce06uAKMh5XM68Nq014lv7CelGhX/pUNIH5CybwhnMn2qqCR8kOnn8WxvlYozcnfpNrsNsrAtMyy12pPUNmEr49t4PvYFzXKzSsKlewzSvUXTrn3Jn1lbwAAAAAASUVORK5CYII=" alt="{{ Lang.get('ticket.im_not_sure') }}">
                        <div class="sp-mt-1 sp-font-semibold">{{ Lang.get('ticket.im_not_sure') }}</div>
                    </a>
                </div>
                <div class="sp-w-full sp-mt-3 sm:sp-w-1/3 sm:sp-mt-0">
                    <a href="{{ route('ticket.frontend.ticket.feedback', [ ticket.number, feedbackToken ]) }}?rating=0">
                        <img class="sp-inline" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAABpFBMVEUAAADnTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDznTDw8vlXlAAAAi3RSTlMAAQIDBAUGBwgJCgsMDQ4PERITFBUWFxgaGxwdHh8gJCYpKissLi8wMzQ2ODo8PT4/QUNERUZHSUpMTk9QUlZXWFlbXF1eYmNmaG9zdHV4fH6ChYiJi4+UlZeYmpudnqClpqitr7C1t7q8vsHDxcfIzM7P0dPV19na3N7g4uTm6Onr7e/x8/X3+fv9/9BgVAAAAkNJREFUGBmFwYlDi2EAx/Hfs/a+UUmtlLPYcuXMGbkSURJCyC20co4ICRVb7ftPe553W9tq5vNREa994FUaa+rmsVr9U8tjCr09YFRK8xjLTe/VCqYP59f19qYqf3Vd9HIC58kqFfPGscZblVd/E2uuWYWqPgNTO1Qs8hRYjCov/Am4F9IKJ4HF9coxL4FeldL6B+aqlNUN9Km0FuC5MurS8EiWiXVElGNiHRFZx4HDCjyCnxWS/ARwXhl+Argo6w7MhmQ1AAdlDeFEFBjCaZRUA5yQdQ0mjawZnA4FZnCOyLoK05LMH9gjJ44TUyCOs0PWaqBZ2gLpCjltWAmjQBvWRyNnFC5JXfBMGW3xmSFfWW3xmSFfgU54IQ3DGZXXBAvSa9iu8jzA0zRsVHkGqNYCNOo/gHr9gA0qzwA1egdR5YXab00mv492r1FeGPB1H7q0ZP88WcO+ciKQNjoHI8oyd8j72aSsgzAhbYWkUcZDYGEw1rz5RAJI1iljBPql0CJEFTgFPKlU4GgaPhs5HtAiaRjicrwUPFBOFOiU0w1zRtIWICbrGMyFtaQfpmR5KeiVMwaTRtIN6FFeJeBJugIpT84mYFBS47eJsAqcTvVL2gb0KGMQOKTS1ibhvVFGaBLYo1LWfoHFBuVUzwJ9WimaBHYqb9088LxBxbwBrE4Vqv2KdbtWeeGzKSC9S8W8EZx413rfSOH6fXfTWB8atcLu7yy30GtUgumYotDvPl//0nBhNEXgzUCrUXledX1tpdFyfwF8RgXXQ7P1gQAAAABJRU5ErkJggg==" alt="{{ Lang.get('ticket.bad_not_satisfied') }}">
                        <div class="sp-mt-1 sp-font-semibold">{{ Lang.get('ticket.bad_not_satisfied') }}</div>
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    {% if ticket.user.isAscendingReplyOrder() %}
        {% include 'frontend.' ~ template ~ '.ticket.ticket_messages' %}
    {% endif %}

    {% set channelAddonInstance = ChannelFactory.getChannel(ticket.channel.name) %}
    {% if ticket.locked == 0 and channelAddonInstance.canReplyToTicket(ticket, auth_user() ?: ticket.user) %}
        <div class="add-reply {% if ticket.user.isAscendingReplyOrder() %}sp-mt-6{% else %}sp-mb-6{% endif %}">
            {% include 'frontend.' ~ template ~ '.ticket.forms.message' %}
        </div>
    {% endif %}

    {% if ticket.user.isDescendingReplyOrder() %}
        {% include 'frontend.' ~ template ~ '.ticket.ticket_messages' %}
    {% endif %}

{% endblock %}

{% block scripts_footer %}
    {% if jsValidator|default is not empty %}
        {{ jsValidator|raw }}
    {% endif %}
    {% if jsValidatorFields|default is not empty %}
        {{ jsValidatorFields|raw }}
    {% endif %}

    <!-- WYSIWYG Editor -->
    <script src="{{ asset_rev('resources/assets/libs/editor.min.js') }}"></script>

    <!-- Mark as Resolved button handler -->
    <script>
        (function() {
            var markResolvedButton = document.querySelector('.sp-mark-resolved');
            var closeInput = document.querySelector('input[name="close"]');
            
            // Handle Mark as Resolved button
            if (markResolvedButton && closeInput) {
                markResolvedButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (closeInput) {
                        closeInput.value = '1';
                    }
                    
                    // Submit the message form
                    var messageForm = document.querySelector('.sp-message-form');
                    if (messageForm) {
                        messageForm.submit();
                    }
                });
            }
        })();
    </script>

    <!-- Attachments -->
    <script src="{{ asset_rev('resources/assets/libs/fileupload/js/jquery.fileupload.min.js') }}"></script>
    <script src="{{ asset_rev('resources/assets/libs/att.preview/js/att.preview.min.js') }}"></script>
    <script>
        new FileUpload();
        
        // Make "(Remove)" text clickable for reply history attachments
        $(document).on('click', '.sp-attachments .sp-remove-attachment-text', function(e) {
            e.preventDefault();
            var $link = $(this);
            var url = $link.data('url');
            var guestToken = $link.data('token');
            var attachmentId = $link.data('attachment-id');
            var hash = $link.data('hash');
            var csrfToken = $('meta[name=csrf_token]').prop('content');
            
            if (confirm('Are you sure you want to remove this attachment?')) {
                var postData = {
                    _token: csrfToken,
                    attachment_id: attachmentId,
                    hash: hash
                };
                
                // Add guest token if it exists
                if (guestToken) {
                    postData.token = guestToken;
                }
                
                $.ajax({
                    url: url,
                    method: 'POST',
                    data: postData,
                    success: function() {
                        $link.closest('li').fadeOut(function() {
                            $(this).remove();
                        });
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to remove attachment.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        showErrorAtTop(errorMessage);
                    }
                });
            }
        });
        
        // Make "(Remove)" text clickable for new reply form attachments
        $(document).on('click', '.sp-attached-files .sp-remove-attachment-text', function(e) {
            e.preventDefault();
            var $li = $(this).closest('li');
            var $deleteBtn = $li.find('.sp-delete-attachment');
            if ($deleteBtn.length) {
                // Show the delete button if it's hidden (for newly uploaded attachments)
                if ($deleteBtn.hasClass('sp-hidden')) {
                    $deleteBtn.removeClass('sp-hidden');
                }
                // Trigger the click on the delete button to open the confirmation modal
                $deleteBtn.trigger('click');
            }
        });
        
        // Function to show error at top of page
        function showErrorAtTop(message) {
            var $errorBox = $('#js-message-box');
            if ($errorBox.length) {
                $errorBox.removeClass('sp-hidden').addClass('sp-alert-error').html(message);
                $errorBox[0].style.display = 'block';
                
                // Scroll to top
                $('html, body').animate({
                    scrollTop: 0
                }, 300);
            }
        }
        
        // Hide all error containers initially and when empty
        function hideEmptyErrorContainers() {
            $('.attachment.sp-alert-error').each(function() {
                var $container = $(this);
                var text = $container.find('.sp-container').text().trim();
                if (!text) {
                    $container.addClass('sp-hidden');
                }
            });
            
            // Hide validation errors that are empty or hidden
            $('.sp-validation-container .error, .sp-validation-container label.error').each(function() {
                var $error = $(this);
                var text = $error.text().trim();
                if (!text || $error.hasClass('sp-hidden')) {
                    $error.addClass('sp-hidden');
                }
            });
            
            // Update validation container class based on visible errors
            $('.sp-validation-container').each(function() {
                var $container = $(this);
                var hasVisibleError = $container.find('.error:not(.sp-hidden), label.error:not(.sp-hidden)').length > 0;
                if (hasVisibleError) {
                    $container.addClass('error-active');
                } else {
                    $container.removeClass('error-active');
                }
            });
        }
        
        // Hide empty error containers on page load
        hideEmptyErrorContainers();
        
        // Watch for changes to validation errors
        var observer = new MutationObserver(function(mutations) {
            hideEmptyErrorContainers();
        });
        
        $('.sp-validation-container').each(function() {
            observer.observe(this, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
        });
        
        // Track if there's an active attachment error that should persist
        var hasActiveAttachmentError = false;
        var attachmentErrorMessage = '';
        var errorPersistenceInterval = null;
        
        // Function to start error persistence monitoring
        function startErrorPersistence() {
            if (errorPersistenceInterval) {
                return; // Already running
            }
            errorPersistenceInterval = setInterval(function() {
                if (hasActiveAttachmentError && attachmentErrorMessage) {
                    var $errorBox = $('#js-message-box');
                    if ($errorBox.length && ($errorBox.hasClass('sp-hidden') || !$errorBox.text().trim())) {
                        showErrorAtTop(attachmentErrorMessage);
                    }
                } else {
                    // Clear interval if no active error
                    stopErrorPersistence();
                }
            }, 500);
        }
        
        // Function to stop error persistence monitoring
        function stopErrorPersistence() {
            if (errorPersistenceInterval) {
                clearInterval(errorPersistenceInterval);
                errorPersistenceInterval = null;
            }
        }
        
        // Handle file upload errors
        $(document).on('fileuploadfail', '.sp-file-upload', function(e, data) {
            var errorMessage = 'An error occurred while uploading the file.';
            if (data.jqXHR && data.jqXHR.responseJSON && data.jqXHR.responseJSON.message) {
                errorMessage = data.jqXHR.responseJSON.message;
            } else if (data.jqXHR && data.jqXHR.responseJSON && data.jqXHR.responseJSON.errors) {
                // Handle validation errors (e.g., file extension)
                var errors = data.jqXHR.responseJSON.errors;
                if (errors.files && errors.files.length > 0) {
                    errorMessage = errors.files[0];
                } else if (errors[0]) {
                    errorMessage = errors[0];
                }
            } else if (data.textStatus) {
                errorMessage = data.textStatus;
            }
            
            // Set flag to track active attachment error
            hasActiveAttachmentError = true;
            attachmentErrorMessage = errorMessage;
            
            // Show error at top of page
            showErrorAtTop(errorMessage);
            
            // Start monitoring to ensure error persists
            startErrorPersistence();
            
            // Hide local error containers
            $('.attachment.sp-alert-error').addClass('sp-hidden');
            
            // Remove the failed file from the list
            if (data.context) {
                $(data.context).remove();
            }
        });
        
        // Validate file extensions before upload
        $(document).on('fileuploadadd', '.sp-file-upload', function(e, data) {
            var file = data.files[0];
            if (file && file.name) {
                var fileName = file.name.toLowerCase();
                var allowedExtensions = ['.pdf', '.doc', '.docx', '.txt', '.jpg', '.jpeg', '.png', '.gif', '.zip', '.rar', '.xls', '.xlsx', '.csv'];
                var hasValidExtension = false;
                
                for (var i = 0; i < allowedExtensions.length; i++) {
                    if (fileName.endsWith(allowedExtensions[i])) {
                        hasValidExtension = true;
                        break;
                    }
                }
                
                if (!hasValidExtension) {
                    var errorMessage = 'File type not supported. Please upload a file with one of the following extensions: ' + allowedExtensions.join(', ');
                    
                    // Set flag to track active attachment error
                    hasActiveAttachmentError = true;
                    attachmentErrorMessage = errorMessage;
                    
                    // Show error at top of page
                    showErrorAtTop(errorMessage);
                    
                    // Start monitoring to ensure error persists
                    startErrorPersistence();
                    
                    // Hide local error containers
                    $('.attachment.sp-alert-error').addClass('sp-hidden');
                    
                    // Scroll to top
                    $('html, body').animate({
                        scrollTop: 0
                    }, 300);
                    
                    // Prevent upload
                    e.preventDefault();
                    return false;
                }
            }
        });
        
        // Handle form validation errors - show at top
        $(document).on('submit', '.sp-message-form', function(e) {
            // Check for validation errors after a short delay
            setTimeout(function() {
                var $errors = $('.sp-validation-container .error:not(.sp-hidden), .sp-validation-container label.error:not(.sp-hidden)');
                if ($errors.length) {
                    var errorMessages = [];
                    $errors.each(function() {
                        var errorText = $(this).text().trim();
                        if (errorText) {
                            errorMessages.push(errorText);
                        }
                    });
                    if (errorMessages.length) {
                        showErrorAtTop(errorMessages.join('<br>'));
                    }
                }
            }, 100);
        });
    </script>

    <!-- Custom fields -->
    <script src="{{ asset_rev('resources/assets/general/js/customfields.js') }}"></script>

    <!-- Notifications -->
    <script src="{{ asset_rev('resources/assets/frontend/js/notification.js') }}"></script>
    <script>
        (function (App, Echo) {
            App.Notifications.configure(new Echo({{ echoConfig|raw }}))
        })(App, Echo);
    </script>

    <script src="{{ asset_rev('resources/assets/dist/ticket-view.js') }}"></script>
    <script>
        var ticketId = "{{ ticket.id }}",
            closedStatusId = "{{ Config.get('settings.default_resolved_status') }}",
            descReplyOrder = {% if ticket.user.isDescendingReplyOrder() %}true{% else %}false{% endif %};

        App.extend('FrontendTicketView', new SpTicket.FrontendTicket);
        App.extend('TicketView', new SpTicket.TicketView(App.FrontendTicketView));
        new SpTicket.FrontendDraftMessage;
    </script>

    <script src="{{ asset_rev('resources/assets/frontend/js/ticket.js') }}"></script>
{% endblock %}
