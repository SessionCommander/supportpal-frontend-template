{% extends parent_template %}

{% block title %}{{ Lang.get('core.submit_ticket') }}{% endblock %}

{% block breadcrumb %}
    <span class="page-header-breadcrumb-separator">&raquo;</span>
    <a href="{{ route('ticket.frontend.ticket.createStep1') }}">{{ Lang.get('core.submit_ticket') }}</a>
{% endblock %}

{% block page_title %}
    {{ Lang.get('ticket.enter_ticket_details') }}
{% endblock %}

{% block precontent %}
    <div class="sp-alert sp-alert-error sp-alert-sticky sp-hidden attachment">
        <div class="sp-container sp-mx-auto"></div>
    </div>
{% endblock %}

{% block content %}

    <div style="max-width: 56rem; margin: 0 auto;">
        <div style="background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.5rem; padding: 2rem;">

            {{ form_open({'route': 'ticket.frontend.ticket.storeStep3', 'class': 'validate'}) }}

                {% if not auth_check() %}
                    {{ form_hidden('email', guest_user.email) }}

                    {% if guest_user.firstname is not empty %}
                        {{ form_hidden('firstname', guest_user.firstname) }}
                    {% endif %}
                    {% if guest_user.lastname is not empty %}
                        {{ form_hidden('lastname', guest_user.lastname) }}
                    {% endif %}
                    {% if guest_user.organisation is not empty %}
                        {{ form_hidden('organisation', guest_user.organisation) }}
                    {% endif %}
                {% endif %}

                <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="sp-form-row">
                        {{ form_label('department', Lang.choice('ticket.department', 1)) }}
                        <div class="sp-input-container">
                            {{ form_hidden('department', department.id) }}
                            <span class="department-name" style="display: inline-block; width: 100%; padding: 0.75rem; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.375rem; color: #f3f4f6; font-size: 0.875rem; line-height: 1.5;">{{ department.frontend_name }}</span>
                        </div>
                    </div>

                    {% if department_priorities|length > 1 %}
                        <div class="sp-form-row">
                            {{ form_label('priority', Lang.choice('ticket.priority', 1)) }}
                            <div class="sp-input-container">
                                {{ form_select('priority', department_priorities, null, {'autofocus': 'autofocus', 'style': 'width: 100%; padding: 0.75rem; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.375rem; color: #f3f4f6;'}) }}
                            </div>
                        </div>
                    {% else %}
                        <div></div>
                    {% endif %}
                </div>

                {% if organisationUsers is not empty %}
                    <div class="sp-form-row">
                        {{ form_label('organisationUsers', Lang.get('user.organisation_users')) }}
                        <div class="sp-input-container">
                            <span style="color: #d1d5db; font-size: 0.875rem;">{{ organisationUsers.implode(', ') }}</span>
                            <div style="color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem;">{{ Lang.get('user.organisation_users_ticket') }}</div>
                        </div>
                    </div>
                {% endif %}

                <div class="sp-form-row sp-form-full">
                    {{ form_label('cc[]', Lang.get('ticket.cc')) }}
                    <div class="sp-input-container">
                        {{ form_select('cc[]', [], [], {'multiple': 'multiple', 'class': 'ticket-cc-select', 'style': 'width: 100%;'}) }}
                        <div style="color: #9ca3af; font-size: 0.875rem; margin-top: 0.5rem;">{{ Lang.get('ticket.cc_desc') }}</div>
                    </div>
                </div>

                <div style="margin: 1.5rem 0; border-top: 1px solid rgba(168, 85, 247, 0.2);"></div>

                <div class="sp-form-row sp-form-full">
                    {{ form_label('subject', Lang.get('ticket.subject')) }}
                    <div class="sp-input-container">
                        {{ form_text('subject', null, {'style': 'width: 100%; padding: 0.75rem; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.375rem; color: #f3f4f6;'}) }}
                    </div>
                </div>

                <div class="sp-form-row sp-form-full sp-suggested-articles sp-hidden">
                    <label></label>
                    <div class="sp-input-container">
                        <div style="padding: 1.5rem; background: rgba(17, 24, 39, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.5rem;">
                            <h4 style="font-size: 1.125rem; font-weight: 600; color: white; margin-bottom: 1rem; font-family: var(--font-playfair);">
                                {{ Lang.get('selfservice.related_articles') }}
                            </h4>
                            <div class="sp-articles-list"></div>
                        </div>
                    </div>
                </div>

                <div class="sp-form-row sp-form-full" style="margin-top: 1.5rem;">
                    {{ form_label('text', Lang.choice('general.message', 1)) }}
                    <div class="sp-input-container">
                        {{ form_editor('text') }}

                        <div class="sp-attachment-details">
                            <input type="hidden" name="attachment[]" disabled="disabled" />
                            {% if Request.old() is not empty and Request.old()['attachment'] is not empty %}
                                {% for hash, file in Request.old()['attachment'] %}
                                    <input type="hidden" name="attachment[{{ hash }}]" id="attachment[{{ hash }}]" value="{{ file }}" />
                                {% endfor %}
                            {% endif %}
                        </div>

                        <ul class="sp-attached-files" style="list-style: none; padding: 0; margin: 0.75rem 0;">
                            <li class="sp-hidden" style="display: none;">
                                <span class="sp-file-information">
                                    <span class="sp-filename" style="color: #d1d5db; text-decoration: underline; cursor: pointer;"></span>
                                    <span class="sp-description sp-filesize" style="color: #9ca3af; font-size: 0.875rem; margin-left: 0.5rem;"></span>
                                    <span class="sp-remove-attachment-text" style="color: #ef4444; font-size: 0.875rem; margin-left: 0.5rem; cursor: pointer; text-decoration: underline;">(Remove)</span>
                                </span>
                                <div class="sp-delete-attachment sp-hidden" data-url="{{ route('ticket.frontend.attachment.destroy') }}" style="display: none;"></div>
                                <div class="sp-progress-bar" style="display: none;">
                                    <div class="sp-bar"></div>
                                </div>
                            </li>
                            {% if Request.old() is not empty and Request.old()['attachment'] is not empty %}
                                {% for hash, file in Request.old()['attachment'] %}
                                    <li style="margin-bottom: 0.5rem;">
                                        <span class="sp-file-information">
                                            <span class="sp-filename" style="color: #d1d5db; text-decoration: underline; cursor: pointer;">{{ file }}</span>
                                            <span class="sp-description sp-filesize" style="color: #9ca3af; font-size: 0.875rem; margin-left: 0.5rem;"></span>
                                            <span class="sp-remove-attachment-text" style="color: #ef4444; font-size: 0.875rem; margin-left: 0.5rem; cursor: pointer; text-decoration: underline;">(Remove)</span>
                                        </span>
                                        <div class="sp-delete-attachment" data-url="{{ route('ticket.frontend.attachment.destroy') }}" data-hash="{{ hash }}" style="display: none;"></div>
                                    </li>
                                {% endfor %}
                            {% endif %}
                        </ul>

                        <div style="margin-top: 0.75rem;">
                            <div class="sp-attachment-dragover sp-hidden" style="padding: 2rem; background: rgba(168, 85, 247, 0.1); border: 2px dashed rgba(168, 85, 247, 0.3); border-radius: 0.5rem; text-align: center; color: #a855f7; font-weight: 500;">
                                {{ Lang.get('general.drag_and_drop') }}
                            </div>

                            <label class="sp-file-input" style="display: inline-block; cursor: pointer;">
                                <a class="sp-button" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 0.375rem; color: #d1d5db; text-decoration: none; font-size: 0.875rem; transition: all 0.2s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                                    </svg>
                                    {{ Lang.get('general.add_attachment') }}
                                </a>
                                <input class="sp-file-upload" type="file" name="files[]"
                                       data-url="{{ route('ticket.frontend.attachment.upload') }}" multiple="multiple" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>

                {% include 'frontend.' ~ template ~ '.forms.custom_fields' with {'new': true} %}

                {% if showCaptcha %}
                    <div style="margin: 1.5rem 0; padding: 1.5rem 0; border-top: 1px solid rgba(168, 85, 247, 0.2);"></div>

                    {% if Captcha.isVisible() %}
                        <div class="sp-form-row">
                            <div class="sp-input-container">
                                {{ Captcha.getHtml() }}
                            </div>
                        </div>
                    {% else %}
                        {{ Captcha.getHtml() }}
                    {% endif %}
                {% endif %}

                <div class="sp-form-row" style="margin-top: 1.5rem;">
                    <label></label>
                    <div class="sp-input-container">
                        {{ form_submit(Lang.choice('general.submit', 1), {'style': 'width: 100%; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #7e22ce 0%, #9333ea 50%, #a855f7 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 500; font-size: 0.875rem; cursor: pointer;'}) }}
                    </div>
                </div>

            {{ form_close() }}
        </div>
    </div>

{% endblock %}

{% block scripts_footer %}
    <script>
        // If we should attempt to fetch related articles
        var relatedArticlesEnabled;
        {% if isModuleEnabled('Selfservice') and Config.get('channel.web.settings.show_related_articles') %}
            relatedArticlesEnabled = true;
        {% else %}
            relatedArticlesEnabled = false;
        {% endif %}
    </script>

    <script src="{{ asset_rev('resources/assets/frontend/js/newticket.js') }}"></script>

    <script src="{{ asset_rev('resources/assets/libs/editor.min.js') }}"></script>

    <!-- Attachments -->
    <script src="{{ asset_rev('resources/assets/libs/fileupload/js/jquery.fileupload.min.js') }}"></script>
    <script>
        new FileUpload();
        
        // Make "(Remove)" text clickable
        $(document).on('click', '.sp-remove-attachment-text', function(e) {
            e.preventDefault();
            var $li = $(this).closest('li');
            var $deleteBtn = $li.find('.sp-delete-attachment');
            if ($deleteBtn.length) {
                // Show the delete button if it's hidden (for newly uploaded attachments)
                if ($deleteBtn.hasClass('sp-hidden')) {
                    $deleteBtn.removeClass('sp-hidden');
                }
                // Trigger the click on the delete button to open the confirmation modal
                $deleteBtn.trigger('click');
            }
        });
        
        // Function to show error at top of page
        function showErrorAtTop(message) {
            var $errorBox = $('#js-message-box');
            if ($errorBox.length) {
                $errorBox.removeClass('sp-hidden').addClass('sp-alert-error').html(message);
                $errorBox[0].style.display = 'block';
                
                // Scroll to top
                $('html, body').animate({
                    scrollTop: 0
                }, 300);
            }
        }
        
        // Hide all error containers initially
        $('.attachment.sp-alert-error').addClass('sp-hidden');
        
        // Handle file upload errors
        $(document).on('fileuploadfail', '.sp-file-upload', function(e, data) {
            var errorMessage = 'An error occurred while uploading the file.';
            if (data.jqXHR && data.jqXHR.responseJSON && data.jqXHR.responseJSON.message) {
                errorMessage = data.jqXHR.responseJSON.message;
            } else if (data.jqXHR && data.jqXHR.responseJSON && data.jqXHR.responseJSON.errors) {
                // Handle validation errors (e.g., file extension)
                var errors = data.jqXHR.responseJSON.errors;
                if (errors.files && errors.files.length > 0) {
                    errorMessage = errors.files[0];
                } else if (errors[0]) {
                    errorMessage = errors[0];
                }
            } else if (data.textStatus) {
                errorMessage = data.textStatus;
            }
            
            // Show error at top of page
            showErrorAtTop(errorMessage);
            
            // Hide local error containers
            $('.attachment.sp-alert-error').addClass('sp-hidden');
            
            // Remove the failed file from the list
            if (data.context) {
                $(data.context).remove();
            }
        });
        
        // Validate file extensions before upload
        $(document).on('fileuploadadd', '.sp-file-upload', function(e, data) {
            var file = data.files[0];
            if (file && file.name) {
                var fileName = file.name.toLowerCase();
                var allowedExtensions = ['.pdf', '.doc', '.docx', '.txt', '.jpg', '.jpeg', '.png', '.gif', '.zip', '.rar', '.xls', '.xlsx', '.csv'];
                var hasValidExtension = false;
                
                for (var i = 0; i < allowedExtensions.length; i++) {
                    if (fileName.endsWith(allowedExtensions[i])) {
                        hasValidExtension = true;
                        break;
                    }
                }
                
                if (!hasValidExtension) {
                    var errorMessage = 'File type not supported. Please upload a file with one of the following extensions: ' + allowedExtensions.join(', ');
                    
                    // Show error at top of page
                    showErrorAtTop(errorMessage);
                    
                    // Hide local error containers
                    $('.attachment.sp-alert-error').addClass('sp-hidden');
                    
                    // Scroll to top
                    $('html, body').animate({
                        scrollTop: 0
                    }, 300);
                    
                    // Prevent upload
                    e.preventDefault();
                    return false;
                }
            }
        });
        
        // Handle form validation errors - show at top
        $(document).on('submit', 'form.validate', function(e) {
            // Check for validation errors after a short delay
            setTimeout(function() {
                var $errors = $('.sp-validation-container .error:not(.sp-hidden), .sp-validation-container label.error:not(.sp-hidden)');
                if ($errors.length) {
                    var errorMessages = [];
                    $errors.each(function() {
                        var errorText = $(this).text().trim();
                        if (errorText) {
                            errorMessages.push(errorText);
                        }
                    });
                    if (errorMessages.length) {
                        showErrorAtTop(errorMessages.join('<br>'));
                    }
                }
            }, 100);
        });
    </script>

    <!-- Custom fields -->
    <script src="{{ asset_rev('resources/assets/general/js/customfields.js') }}"></script>

    {% if showCaptcha %}
        {{ Captcha.getJs() }}
    {% endif %}

    {% if jsValidator|default is not empty %}
        {{ jsValidator|raw }}
    {% endif %}
{% endblock %}
